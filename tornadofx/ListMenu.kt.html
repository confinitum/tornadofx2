<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ListMenu.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tornadofx2</a> &gt; <a href="index.source.html" class="el_package">tornadofx</a> &gt; <span class="el_source">ListMenu.kt</span></div><h1>ListMenu.kt</h1><pre class="source lang-java linenums">@file:Suppress(&quot;unused&quot;, &quot;UNCHECKED_CAST&quot;)

package tornadofx

import javafx.beans.DefaultProperty
import javafx.beans.property.*
import javafx.collections.ObservableList
import javafx.css.*
import javafx.event.EventTarget
import javafx.geometry.Orientation
import javafx.geometry.Orientation.VERTICAL
import javafx.geometry.Side
import javafx.scene.Node
import javafx.scene.control.Control
import javafx.scene.control.Skin
import javafx.scene.control.SkinBase
import javafx.scene.image.ImageView
import javafx.scene.input.MouseEvent
import javafx.scene.layout.Region
import javafx.scene.text.Text
import tornadofx.WizardStyles.Companion.graphic

@DefaultProperty(&quot;children&quot;)
<span class="nc" id="L24">class ListMenu : Control() {</span>
<span class="nc" id="L25">    private val graphicFixedSizeInternal = FACTORY.createStyleableNumberProperty(this, &quot;graphicFixedSize&quot;, &quot;-fx-graphic-fixed-size&quot;, { it.graphicFixedSizeProperty })</span>
<span class="nc" id="L26">    val graphicFixedSizeProperty: StyleableProperty&lt;Number&gt; get() = graphicFixedSizeInternal</span>
<span class="nc" id="L27">    var graphicFixedSized: Number get() = graphicFixedSizeInternal.value; set(value) {</span>
<span class="nc" id="L28">        graphicFixedSizeInternal.value = value</span>
<span class="nc" id="L29">    }</span>

<span class="nc" id="L31">    val themeProperty = SimpleStringProperty()</span>
<span class="nc" id="L32">    var theme by themeProperty</span>

<span class="nc" id="L34">    val activeItemProperty: ObjectProperty&lt;ListMenuItem?&gt; = object : SimpleObjectProperty&lt;ListMenuItem?&gt;(this, &quot;active&quot;) {</span>
        override fun set(item: ListMenuItem?) {
<span class="nc" id="L36">            val previouslyActive = get()</span>
<span class="nc bnc" id="L37" title="All 2 branches missed.">            if (item === previouslyActive)</span>
<span class="nc" id="L38">                return</span>

<span class="nc bnc" id="L40" title="All 2 branches missed.">            previouslyActive?.pseudoClassStateChanged(ACTIVE_PSEUDOCLASS_STATE, false)</span>
<span class="nc bnc" id="L41" title="All 4 branches missed.">            previouslyActive?.internalActiveProperty?.value = false</span>
<span class="nc bnc" id="L42" title="All 2 branches missed.">            item?.pseudoClassStateChanged(ACTIVE_PSEUDOCLASS_STATE, true)</span>
<span class="nc bnc" id="L43" title="All 4 branches missed.">            item?.internalActiveProperty?.value = true</span>
<span class="nc" id="L44">            super.set(item)</span>
<span class="nc" id="L45">        }</span>
    }
<span class="nc" id="L47">    var activeItem: ListMenuItem? by activeItemProperty</span>

<span class="nc" id="L49">    val orientationProperty: ObjectProperty&lt;Orientation&gt; = object : SimpleObjectProperty&lt;Orientation&gt;(VERTICAL) {</span>
        override fun invalidated() {
<span class="nc" id="L51">            isNeedsLayout = true</span>
<span class="nc" id="L52">            requestLayout()</span>
<span class="nc" id="L53">        }</span>
    }
<span class="nc" id="L55">    var orientation: Orientation by orientationProperty</span>

<span class="nc" id="L57">    val iconPositionProperty: ObjectProperty&lt;Side&gt; = object : SimpleObjectProperty&lt;Side&gt;(Side.LEFT) {</span>
        override fun invalidated() {
<span class="nc" id="L59">            children.forEach { child -&gt;</span>
<span class="nc bnc" id="L60" title="All 4 branches missed.">                (child as? ListMenuItem)?.needsLayout()</span>
<span class="nc" id="L61">            }</span>
<span class="nc" id="L62">        }</span>
    }
<span class="nc" id="L64">    var iconPosition: Side by iconPositionProperty</span>

<span class="nc" id="L66">    init {</span>
<span class="nc" id="L67">        styleClass.add(&quot;list-menu&quot;)</span>
<span class="nc" id="L68">        isFocusTraversable = true</span>
<span class="nc" id="L69">        themeProperty.addListener { _, oldTheme, newTheme -&gt;</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">            if (oldTheme != null) removeClass(oldTheme)</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">            if (newTheme != null) addClass(newTheme)</span>
<span class="nc" id="L72">        }</span>
<span class="nc" id="L73">    }</span>

<span class="nc" id="L75">    override fun getControlCssMetaData(): List&lt;CssMetaData&lt;out Styleable, *&gt;&gt; = FACTORY.cssMetaData</span>

<span class="nc" id="L77">    override fun createDefaultSkin() = ListMenuSkin(this)</span>

<span class="nc bnc" id="L79" title="All 2 branches missed.">    val items: ObservableList&lt;ListMenuItem&gt; get() = children as ObservableList&lt;ListMenuItem&gt;</span>

<span class="nc" id="L81">    override fun getUserAgentStylesheet(): String = ListMenu::class.java.getResource(&quot;listmenu.css&quot;).toExternalForm()</span>

    fun item(
<span class="nc" id="L84">            text : String? = null,</span>
<span class="nc" id="L85">            graphic : Node? = null,</span>
<span class="nc" id="L86">            tag : Any? = null,</span>
<span class="nc" id="L87">            op : ListMenuItem.() -&gt; Unit = {}</span>
<span class="nc bnc" id="L88" title="All 4 branches missed.">    ) = ListMenuItem(text ?: tag?.toString(), graphic).attachTo(this, op){</span>
<span class="nc" id="L89">        it.tag = tag</span>
<span class="nc" id="L90">    }</span>

    companion object {
<span class="nc" id="L93">        private val ACTIVE_PSEUDOCLASS_STATE = PseudoClass.getPseudoClass(&quot;active&quot;)</span>
<span class="nc" id="L94">        private val FACTORY = StyleablePropertyFactory&lt;ListMenu&gt;(Region.getClassCssMetaData())</span>
    }
}

<span class="nc" id="L98">class ListMenuItem(text: String? = null, graphic: Node? = null) : Control() {</span>
<span class="nc" id="L99">    val graphicProperty: ObjectProperty&lt;Node&gt; = SimpleObjectProperty(this, &quot;graphic&quot;, graphic)</span>
<span class="nc" id="L100">    var graphic: Node? by graphicProperty</span>

<span class="nc" id="L102">    val textProperty: StringProperty = SimpleStringProperty(text)</span>
<span class="nc" id="L103">    var text: String? by textProperty</span>

<span class="nc" id="L105">    internal val internalActiveProperty = ReadOnlyBooleanWrapper()</span>
<span class="nc" id="L106">    val activeProperty: ReadOnlyBooleanProperty = internalActiveProperty.readOnlyProperty</span>
<span class="nc" id="L107">    val active by activeProperty</span>

<span class="nc" id="L109">    init {</span>
<span class="nc" id="L110">        styleClass.add(&quot;list-item&quot;)</span>
<span class="nc" id="L111">        isFocusTraversable = true</span>
<span class="nc" id="L112">    }</span>

    override fun createDefaultSkin(): Skin&lt;*&gt; {
<span class="nc" id="L115">        return ListMenuItemSkin(this)</span>
    }

    fun needsLayout() {
<span class="nc" id="L119">        isNeedsLayout = true</span>
<span class="nc" id="L120">        requestLayout()</span>
<span class="nc" id="L121">    }</span>

    fun whenSelected(op: () -&gt; Unit) {
<span class="nc bnc" id="L124" title="All 2 branches missed.">        activeProperty.onChange { if (it) op() }</span>
<span class="nc" id="L125">    }</span>

    internal val menu: ListMenu
<span class="nc bnc" id="L128" title="All 2 branches missed.">        get() = parent as ListMenu</span>
}

<span class="nc" id="L131">class ListMenuSkin(control: ListMenu) : SkinBase&lt;ListMenu&gt;(control) {</span>

<span class="nc" id="L133">    private fun acc(fn: (Node) -&gt; Double) = children.sumByDouble { fn(it) }</span>

<span class="nc bnc" id="L135" title="All 2 branches missed.">    private fun biggest(fn: (Node) -&gt; Double) = children.map { fn(it) }.max() ?: 0.0</span>

    override fun computeMinWidth(height: Double, topInset: Double, rightInset: Double, bottomInset: Double, leftInset: Double) =
<span class="nc bnc" id="L138" title="All 2 branches missed.">            if (skinnable.orientation == VERTICAL) biggest { it.minWidth(height) } else acc { it.minWidth(height) }</span>

    override fun computeMinHeight(width: Double, topInset: Double, rightInset: Double, bottomInset: Double, leftInset: Double) =
<span class="nc bnc" id="L141" title="All 2 branches missed.">            if (skinnable.orientation == VERTICAL) acc { it.minHeight(width) } else biggest { it.minHeight(width) }</span>

    override fun computePrefWidth(height: Double, topInset: Double, rightInset: Double, bottomInset: Double, leftInset: Double): Double {
<span class="nc bnc" id="L144" title="All 2 branches missed.">        val prefWidth = if (skinnable.orientation == VERTICAL)</span>
<span class="nc" id="L145">            biggest { it.prefWidth(height) } + leftInset + rightInset</span>
        else
<span class="nc" id="L147">            acc { it.prefWidth(height) } + leftInset + rightInset</span>

<span class="nc" id="L149">        return Math.max(prefWidth, skinnable.prefWidth)</span>
    }

    override fun computePrefHeight(width: Double, topInset: Double, rightInset: Double, bottomInset: Double, leftInset: Double): Double {
<span class="nc bnc" id="L153" title="All 2 branches missed.">        val prefHeight = if (skinnable.orientation == VERTICAL)</span>
<span class="nc" id="L154">            acc { it.prefHeight(width) } + topInset + bottomInset</span>
        else
<span class="nc" id="L156">            biggest { it.prefHeight(width) } + topInset + bottomInset</span>

<span class="nc" id="L158">        return Math.max(prefHeight, skinnable.prefHeight)</span>
    }

    override fun computeMaxWidth(height: Double, topInset: Double, rightInset: Double, bottomInset: Double, leftInset: Double) =
<span class="nc bnc" id="L162" title="All 2 branches missed.">            if (skinnable.maxWidth == Region.USE_COMPUTED_SIZE) computePrefWidth(height, topInset, rightInset, bottomInset, leftInset) else skinnable.maxWidth</span>

    override fun computeMaxHeight(width: Double, topInset: Double, rightInset: Double, bottomInset: Double, leftInset: Double) =
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if (skinnable.maxHeight == Region.USE_COMPUTED_SIZE) computePrefHeight(width, topInset, rightInset, bottomInset, leftInset) else skinnable.maxHeight</span>

    override fun layoutChildren(x: Double, y: Double, w: Double, h: Double) {
<span class="nc" id="L168">        var currentX = x</span>
<span class="nc" id="L169">        var currentY = y</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">        for (node in children) {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">            if (skinnable.orientation == VERTICAL) {</span>
<span class="nc" id="L172">                val prefHeight = node.prefHeight(-1.0)</span>
<span class="nc" id="L173">                node.resizeRelocate(currentX, currentY, w, prefHeight)</span>
<span class="nc" id="L174">                currentY += prefHeight</span>
            } else {
<span class="nc" id="L176">                val prefWidth = node.prefWidth(-1.0)</span>
<span class="nc" id="L177">                node.resizeRelocate(currentX, currentY, prefWidth, h)</span>
<span class="nc" id="L178">                currentX += prefWidth</span>
            }
        }
<span class="nc" id="L181">    }</span>
}

<span class="nc" id="L184">class ListMenuItemSkin(control: ListMenuItem) : SkinBase&lt;ListMenuItem&gt;(control) {</span>
<span class="nc" id="L185">    val text = Text().addClass(&quot;text&quot;)</span>

    private fun registerGraphic(node: Node) {
<span class="nc" id="L188">        children.add(node)</span>
<span class="nc" id="L189">        node.addClass(&quot;graphic&quot;)</span>
<span class="nc bnc" id="L190" title="All 4 branches missed.">        (node as? ImageView)?.isMouseTransparent = true</span>
<span class="nc" id="L191">    }</span>

<span class="nc" id="L193">    init {</span>
<span class="nc" id="L194">        text.textProperty().bind(control.textProperty)</span>
<span class="nc" id="L195">        children.add(text)</span>

<span class="nc bnc" id="L197" title="All 2 branches missed.">        skinnable.graphic?.let { registerGraphic(it) }</span>

<span class="nc" id="L199">        skinnable.graphicProperty.addListener { _, old, new -&gt;</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">            if (old != null) children.remove(old)</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">            if (new != null) registerGraphic(new)</span>
<span class="nc" id="L202">        }</span>

<span class="nc" id="L204">        control.addEventHandler(MouseEvent.MOUSE_PRESSED) {</span>
<span class="nc" id="L205">            control.requestFocus()</span>
<span class="nc" id="L206">            control.menu.activeItem = control</span>
<span class="nc" id="L207">        }</span>
<span class="nc" id="L208">    }</span>

    override fun computePrefWidth(height: Double, topInset: Double, rightInset: Double, bottomInset: Double, leftInset: Double): Double {
<span class="nc bnc" id="L211" title="All 6 branches missed.">        var w = if (text.text.isNullOrBlank()) 0.0 else text.prefWidth(height)</span>

<span class="nc bnc" id="L213" title="All 2 branches missed.">        skinnable.graphic?.let { graphic -&gt;</span>
<span class="nc" id="L214">            val graphicSize = Math.max(graphic.prefWidth(-1.0), graphicFixedSize)</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">            if (iconPosition.isVertical)</span>
<span class="nc" id="L216">                w += graphicSize</span>
            else
<span class="nc" id="L218">                w = Math.max(w, graphicSize)</span>
<span class="nc" id="L219">        }</span>

<span class="nc" id="L221">        return w + leftInset + rightInset</span>
    }

    override fun computePrefHeight(width: Double, topInset: Double, rightInset: Double, bottomInset: Double, leftInset: Double): Double {
<span class="nc bnc" id="L225" title="All 6 branches missed.">        var h = if (text.text.isNullOrBlank()) 0.0 else text.prefHeight(width)</span>

<span class="nc bnc" id="L227" title="All 2 branches missed.">        skinnable.graphic?.let { graphic -&gt;</span>
<span class="nc" id="L228">            val graphicSize = Math.max(graphic.prefHeight(-1.0), graphicFixedSize)</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">            if (iconPosition.isHorizontal)</span>
<span class="nc" id="L230">                h += graphicSize</span>
            else
<span class="nc" id="L232">                h = Math.max(h, graphicSize)</span>
<span class="nc" id="L233">        }</span>
<span class="nc" id="L234">        return h + topInset + bottomInset</span>
    }

    override fun computeMaxWidth(height: Double, topInset: Double, rightInset: Double, bottomInset: Double, leftInset: Double): Double {
<span class="nc" id="L238">        return computePrefWidth(height, topInset, rightInset, bottomInset, leftInset)</span>
    }

    override fun computeMaxHeight(width: Double, topInset: Double, rightInset: Double, bottomInset: Double, leftInset: Double): Double {
<span class="nc" id="L242">        return computePrefHeight(width, topInset, rightInset, bottomInset, leftInset)</span>
    }

    override fun computeMinWidth(height: Double, topInset: Double, rightInset: Double, bottomInset: Double, leftInset: Double) =
<span class="nc" id="L246">            computePrefWidth(height, topInset, rightInset, bottomInset, leftInset)</span>

    override fun computeMinHeight(width: Double, topInset: Double, rightInset: Double, bottomInset: Double, leftInset: Double) =
<span class="nc" id="L249">            computePrefHeight(width, topInset, rightInset, bottomInset, leftInset)</span>

<span class="nc" id="L251">    private val iconPosition: Side get() = skinnable.menu.iconPosition</span>

<span class="nc bnc" id="L253" title="All 6 branches missed.">    private val textPrefWidth: Double = if (text.text.isNullOrBlank()) 0.0 else text.prefWidth(-1.0)</span>
<span class="nc bnc" id="L254" title="All 6 branches missed.">    private val textPrefHeight: Double = if (text.text.isNullOrBlank()) 0.0 else text.prefHeight(-1.0)</span>

    override fun layoutChildren(x: Double, y: Double, w: Double, h: Double) {
<span class="nc" id="L257">        var currentX = x</span>
<span class="nc" id="L258">        var currentY = y</span>
<span class="nc" id="L259">        val graphic = skinnable.graphic</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">        val hasText = textPrefWidth &gt; 0.0</span>

<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (!hasText) {</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">            if (graphic != null) {</span>
<span class="nc" id="L264">                val centeredX = x + w / 2 - graphic.layoutBounds.width / 2</span>
<span class="nc" id="L265">                val centeredY = y + h / 2 - graphic.layoutBounds.height / 2</span>
<span class="nc" id="L266">                graphic.relocate(centeredX, centeredY)</span>
            }
<span class="nc" id="L268">            return</span>
        }

<span class="nc bnc" id="L271" title="All 5 branches missed.">        when (iconPosition) {</span>
            Side.TOP -&gt; {
<span class="nc bnc" id="L273" title="All 2 branches missed.">                if (graphic != null) {</span>
<span class="nc" id="L274">                    val centeredX = currentX + w / 2 - graphic.layoutBounds.width / 2</span>
<span class="nc" id="L275">                    graphic.relocate(centeredX, currentY)</span>
<span class="nc" id="L276">                    currentY += Math.max(graphic.layoutBounds.height, graphicFixedSize)</span>
                }
<span class="nc" id="L278">                val centeredX = currentX + w / 2 - textPrefWidth / 2</span>
<span class="nc" id="L279">                text.resizeRelocate(centeredX, currentY, textPrefWidth, textPrefHeight)</span>
            }
            Side.BOTTOM -&gt; {
<span class="nc bnc" id="L282" title="All 2 branches missed.">                if (hasText) {</span>
<span class="nc" id="L283">                    val centeredX = currentX + w / 2 - textPrefWidth / 2</span>
<span class="nc" id="L284">                    text.resizeRelocate(centeredX, currentY, textPrefWidth, textPrefHeight)</span>
<span class="nc" id="L285">                    currentY += textPrefHeight</span>
                }

<span class="nc bnc" id="L288" title="All 2 branches missed.">                if (graphic != null) {</span>
<span class="nc" id="L289">                    val fixedSize = graphicFixedSize</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">                    if (fixedSize &gt; graphic.layoutBounds.height) {</span>
<span class="nc" id="L291">                        currentY += (fixedSize - graphic.layoutBounds.height) / 2</span>
                    }
<span class="nc" id="L293">                    val centeredX = currentX + w / 2 - graphic.layoutBounds.width / 2</span>
<span class="nc" id="L294">                    graphic.relocate(centeredX, currentY)</span>
                }
            }

            Side.LEFT -&gt; {
<span class="nc bnc" id="L299" title="All 2 branches missed.">                if (graphic != null) {</span>
<span class="nc" id="L300">                    val centeredY = currentY + h / 2 - graphic.layoutBounds.height / 2</span>
<span class="nc" id="L301">                    graphic.relocate(currentX, centeredY)</span>
<span class="nc" id="L302">                    currentX += Math.max(graphic.layoutBounds.width, graphicFixedSize)</span>
                }
<span class="nc" id="L304">                val centeredY = currentY + h / 2 - textPrefHeight / 2</span>
<span class="nc" id="L305">                text.resizeRelocate(currentX, centeredY, textPrefWidth, textPrefHeight)</span>
            }
            Side.RIGHT -&gt; {
<span class="nc bnc" id="L308" title="All 2 branches missed.">                if (graphic != null) {</span>
<span class="nc" id="L309">                    val centeredY = currentY + h / 2 - graphic.layoutBounds.height / 2</span>
<span class="nc" id="L310">                    val graphicWidth = Math.max(graphic.layoutBounds.width, graphicFixedSize)</span>
<span class="nc" id="L311">                    graphic.resizeRelocate(w - skinnable.padding.right, centeredY, graphicWidth, graphic.prefHeight(-1.0))</span>
                }

<span class="nc" id="L314">                val centeredY = currentY + h / 2 - textPrefHeight / 2</span>
<span class="nc" id="L315">                text.resizeRelocate(currentX, centeredY, textPrefWidth, textPrefHeight)</span>
            }
        }
<span class="nc" id="L318">    }</span>

<span class="nc" id="L320">    private val graphicFixedSize: Double get() = skinnable.menu.graphicFixedSizeProperty.value.toDouble()</span>
}

fun EventTarget.listmenu(
<span class="nc" id="L324">        orientation: Orientation = VERTICAL,</span>
<span class="nc" id="L325">        iconPosition: Side = Side.LEFT,</span>
<span class="nc" id="L326">        theme: String? = null,</span>
<span class="nc" id="L327">        tag: Any? = null,</span>
<span class="nc" id="L328">        op: ListMenu.() -&gt; Unit = {}</span>
<span class="nc" id="L329">)= ListMenu().attachTo(this, op) {</span>
<span class="nc" id="L330">    it.orientation = orientation</span>
<span class="nc" id="L331">    it.iconPosition = iconPosition</span>
<span class="nc" id="L332">    it.theme = theme</span>
<span class="nc" id="L333">    it.tag = tag</span>
<span class="nc" id="L334">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>