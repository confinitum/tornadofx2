<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Commands.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tornadofx2</a> &gt; <a href="index.source.html" class="el_package">tornadofx</a> &gt; <span class="el_source">Commands.kt</span></div><h1>Commands.kt</h1><pre class="source lang-java linenums">@file:Suppress(&quot;unused&quot;, &quot;UNCHECKED_CAST&quot;)

package tornadofx

import javafx.application.Platform
import javafx.application.Platform.isFxApplicationThread
import javafx.beans.binding.BooleanExpression
import javafx.beans.property.*
import javafx.scene.control.ButtonBase
import javafx.scene.control.ChoiceBox
import javafx.scene.control.MenuItem
import javafx.scene.control.TextField
import tornadofx.Command.Companion.CommandKey
import tornadofx.Command.Companion.CommandParameterKey
import kotlin.concurrent.thread

<span class="nc" id="L17">open class Command&lt;in T&gt;(</span>
<span class="nc" id="L18">        val action: (T?) -&gt; Unit,</span>
<span class="nc" id="L19">        val enabled: BooleanExpression = SimpleBooleanProperty(true),</span>
<span class="nc" id="L20">        val async: Boolean = false,</span>
<span class="nc" id="L21">        val ui: Boolean = false</span>
) {
<span class="nc" id="L23">    val running: ReadOnlyBooleanProperty = SimpleBooleanProperty(false)</span>
<span class="nc" id="L24">    val isRunning: Boolean get() = running.value</span>
<span class="nc" id="L25">    val isEnabled: Boolean get() = enabled.value</span>

<span class="nc" id="L27">    internal val disabledProperty = enabled.not().or(running)</span>

<span class="nc" id="L29">    fun execute() = execute(null as T?)</span>

    fun execute(param: T?) {
<span class="nc bnc" id="L32" title="All 4 branches missed.">        if (isRunning || disabledProperty.value) return</span>
<span class="nc bnc" id="L33" title="All 2 branches missed.">        if (async) thread(true) { doRun(param) } else doRun(param)</span>
<span class="nc" id="L34">    }</span>

    private fun doRun(param: T?) {
<span class="nc bnc" id="L37" title="All 4 branches missed.">        if (ui &amp;&amp; !isFxApplicationThread()) {</span>
<span class="nc bnc" id="L38" title="All 2 branches missed.">            if (async) {</span>
<span class="nc" id="L39">                Platform.runLater { setRunningAndRun(param) }</span>
            } else {
<span class="nc" id="L41">                FX.runAndWait { setRunningAndRun(param) }</span>
<span class="nc" id="L42">            }</span>
        } else {
<span class="nc" id="L44">            setRunningAndRun(param)</span>
        }
<span class="nc" id="L46">    }</span>

    private fun setRunningAndRun(param: T?) {
<span class="nc bnc" id="L49" title="All 2 branches missed.">        (running as BooleanProperty).value = true</span>
<span class="nc" id="L50">        try {</span>
<span class="nc" id="L51">            action(param)</span>
        } finally {
<span class="nc" id="L53">            running.value = false</span>
        }
<span class="nc" id="L55">    }</span>

    companion object {
<span class="nc" id="L58">        init {</span>
<span class="nc" id="L59">            FX.log.warning(&quot;The Commands feature is experimental and subject to change even in minor releases!&quot;)</span>
<span class="nc" id="L60">        }</span>

<span class="nc" id="L62">        internal val CommandKey = &quot;tornadofx.Command&quot;</span>
<span class="nc" id="L63">        internal val CommandParameterKey = &quot;tornadofx.CommandParam&quot;</span>
    }
}


/**
 * Create a command with a non null parameter where the is a function reference.
 */
<span class="nc" id="L71">fun &lt;T&gt; command(action: (T) -&gt; Unit, enabled: BooleanExpression = SimpleBooleanProperty(true), async: Boolean = false, ui: Boolean = false) = Command&lt;T&gt;({ action(it!!) }, enabled, async, ui)</span>

/**
 * Create a command with a nullable parameter where the is either a lambda or a function reference.
 *
 * The noarg parameter is useless, but a trick to help Kotlin differentiate between the no null parameter version of this function.
 */
<span class="nc" id="L78">fun &lt;T&gt; command(action: (T?) -&gt; Unit, enabled: BooleanExpression = SimpleBooleanProperty(true), async: Boolean = false, ui: Boolean = false, @Suppress(&quot;UNUSED_PARAMETER&quot;) nullable: Boolean = true) = Command&lt;T?&gt;({ action(it) }, enabled, async, ui)</span>

/**
 * Create a command with a nullable parameter where the is a lambda.
 *
 * The noarg parameter is useless, but a trick to help Kotlin differentiate between the no null parameter version of this function.
 */
<span class="nc" id="L85">fun &lt;T&gt; command(enabled: BooleanExpression = SimpleBooleanProperty(true), async: Boolean = false, ui: Boolean = false, @Suppress(&quot;UNUSED_PARAMETER&quot;) nullable: Boolean = true, action: (T?) -&gt; Unit) = Command&lt;T?&gt;({ action(it) }, enabled, async, ui)</span>

/**
 * Create a parameterless command where the action is a function reference.
 */
<span class="nc" id="L90">fun command(action: () -&gt; Unit, enabled: BooleanExpression = SimpleBooleanProperty(true), async: Boolean = false, ui: Boolean = false) = Command&lt;Any&gt;({ action() }, enabled, async, ui)</span>

/**
 * Create a parameterless command where the action is a lambda.
 * This overload allows the command to be defined as the last parameter
 */
<span class="nc" id="L96">fun command(enabled: BooleanExpression = SimpleBooleanProperty(true), async: Boolean = false, ui: Boolean = false, action: () -&gt; Unit) = Command&lt;Any&gt;({ action() }, enabled, async, ui)</span>

var ButtonBase.commandProperty: ObjectProperty&lt;Command&lt;*&gt;&gt;
<span class="nc" id="L99">    get() = properties.getOrPut(CommandKey) {</span>
<span class="nc" id="L100">        SimpleObjectProperty&lt;Command&lt;*&gt;&gt;().apply {</span>
<span class="nc" id="L101">            onChange {</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">                if (it == null) disableProperty().unbind()</span>
<span class="nc" id="L103">                else disableProperty().cleanBind(it.disabledProperty)</span>
<span class="nc" id="L104">            }</span>
<span class="nc bnc" id="L105" title="All 4 branches missed.">            this@commandProperty.action { (value as? Command&lt;Any?&gt;)?.execute(commandParameter) }</span>
<span class="nc" id="L106">        }</span>
<span class="nc" id="L107">    } as ObjectProperty&lt;Command&lt;*&gt;&gt;</span>
<span class="nc" id="L108">    set(value) { properties.put(CommandKey, value) }</span>

var ButtonBase.command: Command&lt;*&gt;
<span class="nc" id="L111">    get() = commandProperty.value</span>
    set(value) {

<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (value is CommandWithParameter) {</span>
<span class="nc" id="L115">            commandProperty.value = value.command</span>
<span class="nc" id="L116">            commandParameter = value.parameter</span>
        } else {
<span class="nc" id="L118">            commandProperty.value = value as Command&lt;Any?&gt;</span>
        }
<span class="nc" id="L120">    }</span>

var ButtonBase.commandParameterProperty: Property&lt;Any?&gt;
<span class="nc" id="L123">    get() = properties.getOrPut(CommandParameterKey) {</span>
<span class="nc" id="L124">        SimpleObjectProperty&lt;Any?&gt;()</span>
<span class="nc" id="L125">    } as Property&lt;Any?&gt;</span>
<span class="nc" id="L126">    set(value) { properties.put(CommandParameterKey, value) }</span>

var ButtonBase.commandParameter: Any?
<span class="nc" id="L129">    get() = commandParameterProperty.value</span>
    set(value) {
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (value is Property&lt;*&gt;) {</span>
<span class="nc" id="L132">            commandParameterProperty = value as Property&lt;Any?&gt;</span>
        } else {
<span class="nc" id="L134">            commandParameterProperty.value = value</span>
        }
<span class="nc" id="L136">    }</span>

var MenuItem.commandProperty: Property&lt;Command&lt;*&gt;&gt;
<span class="nc" id="L139">    get() = properties.getOrPut(CommandKey) {</span>
<span class="nc" id="L140">        SimpleObjectProperty&lt;Command&lt;*&gt;&gt;().apply {</span>
<span class="nc" id="L141">            onChange {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">                if (it == null) disableProperty().unbind()</span>
<span class="nc" id="L143">                else disableProperty().cleanBind(it.disabledProperty)</span>
<span class="nc" id="L144">            }</span>
<span class="nc bnc" id="L145" title="All 4 branches missed.">            this@commandProperty.action { (value as? Command&lt;Any?&gt;)?.execute(commandParameter) }</span>
<span class="nc" id="L146">        }</span>
<span class="nc" id="L147">    } as Property&lt;Command&lt;*&gt;&gt;</span>
<span class="nc" id="L148">    set(value) { properties.put(CommandKey, value) }</span>

var MenuItem.command: Command&lt;*&gt;
<span class="nc" id="L151">    get() = commandProperty.value</span>
    set(value) {
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (value is CommandWithParameter) {</span>
<span class="nc" id="L154">            commandProperty.value = value.command</span>
<span class="nc" id="L155">            commandParameter = value.parameter</span>
        } else {
<span class="nc" id="L157">            commandProperty.value = value as Command&lt;Any?&gt;</span>
        }
<span class="nc" id="L159">    }</span>

var MenuItem.commandParameterProperty: Property&lt;Any?&gt;
<span class="nc" id="L162">    get() = properties.getOrPut(CommandParameterKey) {</span>
<span class="nc" id="L163">        SimpleObjectProperty&lt;Any?&gt;()</span>
<span class="nc" id="L164">    } as Property&lt;Any?&gt;</span>
<span class="nc" id="L165">    set(value) { properties.put(CommandParameterKey, value) }</span>

var MenuItem.commandParameter: Any?
<span class="nc" id="L168">    get() = commandParameterProperty.value</span>
    set(value) {
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (value is Property&lt;*&gt;) {</span>
<span class="nc" id="L171">            commandParameterProperty = value as Property&lt;Any?&gt;</span>
        } else {
<span class="nc" id="L173">            commandParameterProperty.value = value</span>
        }
<span class="nc" id="L175">    }</span>

var TextField.commandProperty: Property&lt;Command&lt;*&gt;&gt;
<span class="nc" id="L178">    get() = properties.getOrPut(CommandKey) {</span>
<span class="nc" id="L179">        SimpleObjectProperty&lt;Command&lt;*&gt;&gt;().apply {</span>
<span class="nc" id="L180">            onChange {</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">                if (it == null) disableProperty().unbind()</span>
<span class="nc" id="L182">                else disableProperty().cleanBind(it.disabledProperty)</span>
<span class="nc" id="L183">            }</span>
<span class="nc bnc" id="L184" title="All 4 branches missed.">            this@commandProperty.action { (value as? Command&lt;Any?&gt;)?.execute(commandParameter) }</span>
<span class="nc" id="L185">        }</span>
<span class="nc" id="L186">    } as Property&lt;Command&lt;*&gt;&gt;</span>
<span class="nc" id="L187">    set(value) { properties.put(CommandKey, value) }</span>

var TextField.command: Command&lt;*&gt;
<span class="nc" id="L190">    get() = commandProperty.value</span>
    set(value) {
<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (value is CommandWithParameter) {</span>
<span class="nc" id="L193">            commandProperty.value = value.command</span>
<span class="nc" id="L194">            commandParameter = value.parameter</span>
        } else {
<span class="nc" id="L196">            commandProperty.value = value as Command&lt;Any?&gt;</span>
        }
<span class="nc" id="L198">    }</span>

var TextField.commandParameterProperty: Property&lt;Any?&gt;
<span class="nc" id="L201">    get() = properties.getOrPut(CommandParameterKey) {</span>
<span class="nc" id="L202">        SimpleObjectProperty&lt;Any?&gt;()</span>
<span class="nc" id="L203">    } as Property&lt;Any?&gt;</span>
<span class="nc" id="L204">    set(value) { properties.put(CommandParameterKey, value) }</span>

var TextField.commandParameter: Any?
<span class="nc" id="L207">    get() = commandParameterProperty.value</span>
    set(value) {
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (value is Property&lt;*&gt;) {</span>
<span class="nc" id="L210">            commandParameterProperty = value as Property&lt;Any?&gt;</span>
        } else {
<span class="nc" id="L212">            commandParameterProperty.value = value</span>
        }
<span class="nc" id="L214">    }</span>


var ChoiceBox&lt;*&gt;.commandProperty: Property&lt;Command&lt;*&gt;&gt;
<span class="nc" id="L218">    get() = properties.getOrPut(CommandKey) {</span>
<span class="nc" id="L219">        SimpleObjectProperty&lt;Command&lt;*&gt;&gt;().apply {</span>
<span class="nc" id="L220">            onChange {</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">                if (it == null) disableProperty().unbind()</span>
<span class="nc" id="L222">                else disableProperty().cleanBind(it.disabledProperty)</span>
<span class="nc" id="L223">            }</span>
<span class="nc bnc" id="L224" title="All 4 branches missed.">            this@commandProperty.action { (value as? Command&lt;Any?&gt;)?.execute(commandParameter) }</span>
<span class="nc" id="L225">        }</span>
<span class="nc" id="L226">    } as Property&lt;Command&lt;*&gt;&gt;</span>
<span class="nc" id="L227">    set(value) { properties.put(CommandKey, value) }</span>

var ChoiceBox&lt;*&gt;.command: Command&lt;*&gt;
<span class="nc" id="L230">    get() = commandProperty.value</span>
    set(value) {
<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (value is CommandWithParameter) {</span>
<span class="nc" id="L233">            commandProperty.value = value.command</span>
<span class="nc" id="L234">            commandParameter = value.parameter</span>
        } else {
<span class="nc" id="L236">            commandProperty.value = value as Command&lt;Any?&gt;</span>
        }
<span class="nc" id="L238">    }</span>

var ChoiceBox&lt;*&gt;.commandParameterProperty: Property&lt;Any?&gt;
<span class="nc" id="L241">    get() = properties.getOrPut(CommandParameterKey) {</span>
<span class="nc" id="L242">        SimpleObjectProperty&lt;Any?&gt;()</span>
<span class="nc" id="L243">    } as Property&lt;Any?&gt;</span>
<span class="nc" id="L244">    set(value) { properties.put(CommandParameterKey, value) }</span>

var ChoiceBox&lt;*&gt;.commandParameter: Any?
<span class="nc" id="L247">    get() = commandParameterProperty.value</span>
    set(value) {
<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (value is Property&lt;*&gt;) {</span>
<span class="nc" id="L250">            commandParameterProperty = value as Property&lt;Any?&gt;</span>
        } else {
<span class="nc" id="L252">            commandParameterProperty.value = value</span>
        }
<span class="nc" id="L254">    }</span>

<span class="nc" id="L256">class CommandWithParameter(val command: Command&lt;*&gt;, val parameter: Any?) : Command&lt;Any?&gt;({})</span>

<span class="nc" id="L258">operator fun Command&lt;*&gt;.invoke(parameter: Any?) = CommandWithParameter(this, parameter)</span>

<span class="nc" id="L260">infix fun Command&lt;*&gt;.with(parameter: Any?) = invoke(parameter)</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>